name: Testing + Lint

on:
  - push
  - pull_request

jobs:
  test_macos:

    runs-on: macos-latest
    strategy:
      max-parallel: 3
      matrix:
        python-version: [3.6, 3.7, 3.8]

    steps:
    - uses: actions/checkout@v1

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v1
      with:
        python-version: ${{ matrix.python-version }}

    - name: Homebrew setup
      run: |
        brew update
        brew install freetype pkg-config

    - name: Install dependencies
      run: |
        # Update pip.
        python -m pip install -U pip setuptools wheel | cat

        # Install dependencies for tests.
        pip install --progress-bar=off -U -r tests/requirements-tools.txt -r tests/requirements-libraries.txt

        # Install PyInstaller Hook Sample, to ensure that tests declared in
        # entry-points are discovered.
        pip install https://github.com/pyinstaller/hooksample/archive/v4.0rc1.zip

        # Compile bootloader
        cd bootloader
        python waf distclean all
        cd ..

        # Install PyInstaller.
        pip install --progress-bar=off -e .

        # Make sure the help options print.
        python -m pyinstaller -h

    - name: Run tests
      run: |
        pytest -n 3 --maxfail 3 --durations 10 tests/unit tests/functional --ignore tests/functional/test_libraries.py
